global
    log stdout format raw local0

defaults
    log     global
    mode    tcp
    option  tcplog
    timeout connect 5s
    timeout client  1m
    timeout server  1m

# --- PHẦN 1: GIAO DIỆN WEB ĐỂ THEO DÕI (Optional) ---
# Truy cập: http://localhost:8404/monitor
listen stats
    bind *:8404
    stats enable
    stats uri /monitor
    stats refresh 5s
    # User/Pass để đăng nhập trang web thống kê (Sửa lại tùy ý)
    stats auth admin:123456

# --- PHẦN 2: REDIS FRONTEND (Cổng chính) ---
frontend redis-frontend
    bind *:6379
    default_backend redis-backend

# --- PHẦN 3: REDIS BACKEND (Xử lý logic tìm Master) ---
backend redis-backend
    mode tcp
    balance first  # Luôn ưu tiên server đầu tiên tìm thấy là Master

    # --- KIỂM TRA SỨC KHỎE (QUAN TRỌNG NHẤT) ---
    # HAProxy sẽ đăng nhập vào Redis và hỏi: "Mày có phải Master không?"
    option tcp-check
    
    # 1. Gửi lệnh AUTH password (QUAN TRỌNG: SỬA PASSWORD Ở ĐÂY)
    # Lưu ý: Có dấu cách (\ ) trước mật khẩu
    tcp-check send AUTH\ 12345678\r\n
    
    # 2. Mong chờ Redis trả về OK
    tcp-check expect string +OK
    
    # 3. Gửi lệnh hỏi Role
    tcp-check send info\ replication\r\n
    
    # 4. Chỉ chấp nhận node nào trả lời là "role:master"
    tcp-check expect string role:master

    # --- DANH SÁCH SERVER ---
    # Sử dụng DNS của Docker (127.0.0.11) để tìm IP của các container
    # check inter 5s: Kiểm tra 5 giây 1 lần
    server node0 infra_redis-node-0:6379 check inter 5s resolvers docker_resolver
    server node1 infra_redis-node-1:6379 check inter 5s resolvers docker_resolver
    server node2 infra_redis-node-2:6379 check inter 5s resolvers docker_resolver

# Cấu hình DNS để HAProxy hiểu tên service trong Docker
resolvers docker_resolver
    nameserver dns1 127.0.0.11:53
    resolve_retries 3
    timeout resolve 1s
    timeout retry   1s
    hold valid      10s